name: Playwright CI Tests

on:
  push:
    branches: [ main, master, lesson22 ]
    paths:
      - 'lesson22/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'lesson22/**'

permissions:
  contents: read
  checks: write
  pull-requests: write
  actions: read

env:
  NODE_VERSION: '24.x'
  BUILD_FOLDER: ./lesson22
  AUTOMATION_EXERCISE_EMAIL: ${{ secrets.AUTOMATION_EXERCISE_EMAIL }}
  AUTOMATION_EXERCISE_PASSWORD: ${{ secrets.AUTOMATION_EXERCISE_PASSWORD }}

jobs:
  # ====================================================================
  # JOB 1: Testing and Upload
  # ====================================================================
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.BUILD_FOLDER }}/package-lock.json

      - name: Install dependencies
        working-directory: ${{ env.BUILD_FOLDER }}
        run: npm ci

      - name: Install Playwright Browsers
        working-directory: ${{ env.BUILD_FOLDER }}
        run: npx playwright install --with-deps chromium

      - name: Run Playwright tests
        working-directory: ${{ env.BUILD_FOLDER }}
        run: npm test
        continue-on-error: true

      - name: Upload JSON test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-json
          path: ${{ env.BUILD_FOLDER }}/test-results/test-results.json
          retention-days: 7

      - name: Upload Playwright HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-html-report
          path: ${{ env.BUILD_FOLDER }}/playwright-report
          retention-days: 30

  # ====================================================================
  # JOB 2: Download artifacts and generate reports
  # ====================================================================
  report:
    name: Generate Test Reports
    runs-on: ubuntu-latest
    needs: [test]
    if: always()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Ensure Build Folder Exists
        run: mkdir -p ${{ env.BUILD_FOLDER }}

      - name: Download JSON Report for Summary
        uses: actions/download-artifact@v4
        with:
          name: test-results-json
          path: ${{ env.BUILD_FOLDER }}

      - name: Download HTML Report
        uses: actions/download-artifact@v4
        with:
          name: playwright-html-report
          path: ${{ env.BUILD_FOLDER }}

      - name: List Downloaded Files
        run: ls -R ${{ env.BUILD_FOLDER }}

      - name: Verify JSON Content
        run: cat ${{ env.BUILD_FOLDER }}/test-results.json

      - name: Install dependencies
        working-directory: ${{ env.BUILD_FOLDER }}
        run: npm ci

      - name: Publish Playwright Test Summary
        if: always()
        uses: daun/playwright-report-summary@v3
        with:
          report-file: ${{ env.BUILD_FOLDER }}/test-results.json
          report-tag: 'Playwright Test Results'
          job-summary: true
          create-comment: true

      - name: Comment PR with reports
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## ðŸŽ­ Playwright Test Results Summary

            ### ðŸ“Š Reports
            - **Summary Report:** Available in the **Job Summary**
            - **Playwright HTML Report:** [Artifacts](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}/artifacts)

            ### ðŸ“ Run Details
            - **Run Number:** ${{ github.run_number }}
            - **Commit:** ${{ github.sha }}
            - **Branch:** ${{ github.head_ref || github.ref_name }}

            [View Full Workflow Run](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})
            `;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # ====================================================================
  # JOB 3: Final Notifications and Summary
  # ====================================================================
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [test, report]
    if: always()

    steps:
      - name: Check test status
        id: test_status
        run: |
          if [ "${{ needs.test.result }}" == "success" ]; then
            echo "status=âœ… Tests Passed" >> $GITHUB_OUTPUT
          else
            echo "status=âŒ Tests Failed" >> $GITHUB_OUTPUT
          fi

      - name: Add final summary
        run: |
          echo "## ðŸŽ¯ Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.test_status.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Run number:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
